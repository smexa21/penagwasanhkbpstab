<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPS Tabalong - Survei Harga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size: 10px; }
        th { background-color: #f9fafb; font-weight: 900; }
        /* Memperbesar area klik agar mudah di HP */
        .radio-cell { cursor: pointer; position: relative; }
        .radio-custom { width: 20px; height: 20px; pointer-events: none; }

        /* Gaya Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #0066b2;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.8s ease;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ffc107;
            border-radius: 50%;
            width: 30px; height: 30px;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div id="splash-screen">
        <img src="https://www.bps.go.id/_next/image?url=%2Fassets%2Flogo-bps.png&w=1080&q=75" alt="Logo BPS" class="w-32 h-auto mb-4 animate-pulse">
        <h2 class="text-white font-bold tracking-widest text-sm">BPS KAB. TABALONG</h2>
        <div class="loader"></div>
    </div>

    <div class="bg-[#0066b2] text-white p-4 shadow-lg flex items-center justify-center space-x-4 border-b-4 border-[#ffc107]">
        <img src="https://www.bps.go.id/_next/image?url=%2Fassets%2Flogo-bps.png&w=1080&q=75" alt="Logo BPS" class="h-10 w-auto">
        <div class="text-left">
            <h1 class="text-lg font-bold leading-tight uppercase tracking-tight">Survei Harga</h1>
            <p class="text-[10px] font-bold tracking-widest uppercase text-yellow-300">BPS Kab. Tabalong</p>
        </div>
    </div>

    <div class="p-4 max-w-md mx-auto mb-10">
        <div class="space-y-4 bg-white p-5 rounded-3xl shadow-md border border-gray-200">
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block font-black mb-1 text-[10px] uppercase">Petugas :</label>
                    <input type="text" id="nama" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none text-sm focus:border-[#0066b2]" placeholder="Nama">
                </div>
                <div>
                    <label class="block font-black mb-1 text-[10px] uppercase">Kegiatan :</label>
                    <input type="text" id="kegiatan" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none text-sm focus:border-[#0066b2]" placeholder="HK 1.1 Pasar">
                </div>
            </div>

            <div>
                <label class="block font-black mb-1 text-[10px] uppercase">Responden :</label>
                <input type="text" id="responden" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none text-sm" placeholder="Pasar/Toko">
            </div>

            <div>
                <label class="block font-black mb-1 text-[10px] uppercase text-blue-700">Komoditas :</label>
                <select id="komoditas-select" onchange="toggleLainnya()" class="w-full p-3 border-2 border-blue-100 rounded-xl bg-blue-50 outline-none text-sm font-bold">
                    <option value="">-- Pilih --</option>
                    <option value="Beras">Beras</option>
                    <option value="Bawang Merah">Bawang Merah</option>
                    <option value="Bawang Putih">Bawang Putih</option>
                    <option value="Cabai Merah">Cabai Merah</option>
                    <option value="Cabai Rawit">Cabai Rawit</option>
                    <option value="Daging Ayam Ras">Daging Ayam Ras</option>
                    <option value="Telur Ayam Ras">Telur Ayam Ras</option>
                    <option value="Susu">Susu</option>
                    <option value="Daging Sapi">Daging Sapi</option>
                    <option value="Minyak Goreng">Minyak Goreng</option>
                    <option value="Gula Pasir">Gula Pasir</option>
                    <option value="Ikan Gabus">Ikan Gabus</option>
                    <option value="Lainnya">Lainnya...</option>
                </select>
                <input type="text" id="komoditas-lainnya" class="hidden mt-2 w-full p-3 border-2 border-orange-200 rounded-xl outline-none text-sm bg-orange-50" placeholder="Sebutkan Lainnya">
            </div>

            <div>
                <label class="block font-black mb-1 text-[10px] uppercase">Kualitas :</label>
                <input type="text" id="kualitas" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none text-sm" placeholder="Premium/dll">
            </div>

            <div class="bg-gray-50 p-3 rounded-2xl border border-gray-200">
                <label class="block font-black mb-2 text-[10px] uppercase text-gray-600 italic font-bold text-center">Tabel Perkembangan Harga (Klik untuk Pilih/Batal)</label>
                <table>
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th class="text-red-600">Naik</th>
                            <th class="text-blue-600">Stabil</th>
                            <th class="text-green-600">Turun</th>
                        </tr>
                    </thead>
                    <tbody id="radio-table-body">
                        <tr>
                            <td class="font-bold text-left">Produsen</td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_prod')"><input type="radio" name="p_prod" value="Naik" class="radio-custom"></td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_prod')"><input type="radio" name="p_prod" value="Stabil" class="radio-custom"></td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_prod')"><input type="radio" name="p_prod" value="Turun" class="radio-custom"></td>
                        </tr>
                        <tr>
                            <td class="font-bold text-left">Distributor</td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_dist')"><input type="radio" name="p_dist" value="Naik" class="radio-custom"></td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_dist')"><input type="radio" name="p_dist" value="Stabil" class="radio-custom"></td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_dist')"><input type="radio" name="p_dist" value="Turun" class="radio-custom"></td>
                        </tr>
                        <tr>
                            <td class="font-bold text-left">Konsumen</td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_kons')"><input type="radio" name="p_kons" value="Naik" class="radio-custom"></td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_kons')"><input type="radio" name="p_kons" value="Stabil" class="radio-custom"></td>
                            <td class="radio-cell" onclick="handleRadioClick(this, 'p_kons')"><input type="radio" name="p_kons" value="Turun" class="radio-custom"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div>
                <label class="block font-black mb-1 text-[10px] uppercase text-green-700 font-bold">Harga (Rp) :</label>
                <input type="number" id="harga" class="w-full p-3 border-2 border-green-100 rounded-xl outline-none text-sm font-bold bg-green-50" placeholder="0">
            </div>

            <div>
                <label class="block font-black mb-1 text-[10px] uppercase">Asal Pasokan :</label>
                <select id="pasokan" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none text-sm bg-white">
                    <option value="">-- Pilih Asal Pasokan --</option>
                    <option value="distributor/pedagang besar">Distributor/Pedagang Besar</option>
                    <option value="petani/kandang">Petani/Kandang</option>
                </select>
            </div>

            <div>
                <label class="block font-black mb-1 text-[10px] uppercase">Wilayah :</label>
                <input type="text" id="wilayah" class="w-full p-3 border-2 border-gray-100 rounded-xl outline-none text-sm" placeholder="Nama Wilayah/Kabupaten">
            </div>

            <div class="bg-gray-50 p-3 rounded-2xl border border-gray-200">
                <label class="block font-black mb-2 text-[10px] uppercase">Fenomena tambahan :</label>
                <textarea id="penjelasan" rows="2" class="w-full p-2 border border-gray-200 rounded-xl text-xs outline-none" placeholder="Isi penjelasan fenomena di sini..."></textarea>
            </div>

            <div id="preview-container" class="w-full h-36 bg-gray-50 rounded-2xl flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden relative shadow-inner">
                <img id="image-preview" class="hidden w-full h-full object-cover">
                <span id="placeholder-text" class="text-gray-400 text-[10px] font-bold">AMBIL FOTO</span>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('camera-input').click()" class="bg-[#0066b2] text-white font-bold py-3 rounded-xl text-xs shadow-md active:scale-95 transition-all">üì∏ KAMERA</button>
                <input type="file" id="camera-input" accept="image/*" capture="camera" class="hidden" onchange="previewImage(event)">
                <button onclick="document.getElementById('file-input').click()" class="bg-[#ffc107] text-black font-bold py-3 rounded-xl text-xs shadow-md active:scale-95 transition-all">üñºÔ∏è GALERI</button>
                <input type="file" id="file-input" accept="image/*" class="hidden" onchange="previewImage(event)">
            </div>

            <div id="location-status" class="text-[9px] text-gray-500 italic text-center font-bold">üìç Mencari lokasi GPS...</div>

            <button id="btn-kirim" onclick="sendData()" class="w-full bg-[#28a745] text-white font-black py-4 rounded-2xl shadow-xl text-lg uppercase tracking-tight active:scale-95 transition-all">üöÄ Kirim ke Database</button>
        </div>
        <p class="text-center text-gray-400 text-[9px] mt-6 font-bold uppercase tracking-widest text-xs">BPS KABUPATEN TABALONG</p>
    </div>

    <script>
    let userCoords = "Tidak Terdeteksi";

    window.onload = function() {
        // Logika Menghilangkan Splash Screen setelah 2.5 detik
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => splash.style.display = 'none', 800);
        }, 1000);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                userCoords = pos.coords.latitude + ", " + pos.coords.longitude;
                const loc = document.getElementById('location-status');
                loc.innerHTML = "üìç GPS Terkunci: " + userCoords;
                loc.classList.add('text-green-600');
            });
        }
    };

    function handleRadioClick(cell, groupName) {
        const radio = cell.querySelector('input[type="radio"]');
        if (radio.checked) {
            radio.checked = false;
        } else {
            document.querySelectorAll(`input[name="${groupName}"]`).forEach(r => r.checked = false);
            radio.checked = true;
        }
    }

    function toggleLainnya() {
        const select = document.getElementById('komoditas-select');
        const inputLainnya = document.getElementById('komoditas-lainnya');
        inputLainnya.classList.toggle('hidden', select.value !== "Lainnya");
    }

    function previewImage(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const output = document.getElementById('image-preview');
            output.src = e.target.result;
            output.classList.remove('hidden');
            document.getElementById('placeholder-text').classList.add('hidden');
        };
        if (file) reader.readAsDataURL(file);
    }

    async function sendData() {
        const btn = document.getElementById('btn-kirim');
        const file = document.getElementById('camera-input').files[0] || document.getElementById('file-input').files[0];

        const selectValue = document.getElementById('komoditas-select').value;
        const komoditasFinal = (selectValue === "Lainnya") ? document.getElementById('komoditas-lainnya').value : selectValue;

        const getVal = (name) => {
            const el = document.querySelector(`input[name="${name}"]:checked`);
            return el ? el.value : "-";
        }
        const perkembanganFinal = `Produsen:${getVal('p_prod')}, Dist:${getVal('p_dist')}, Konsumen:${getVal('p_kons')}`;

        if (!document.getElementById('nama').value || !file || !komoditasFinal) {
            alert('Mohon.. Nama, Komoditas, dan Foto wajib diisi ya!');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = "‚è≥ SEDANG MENGIRIM...";

        try {
            // 1. Upload ke ImgBB
            const formData = new FormData();
            formData.append('image', file);
            const imgRes = await fetch(`https://api.imgbb.com/1/upload?key=da686e0dd69fe24a739317f961163f1e`, { method: 'POST', body: formData });
            const imgData = await imgRes.json();
            const photoUrl = imgData.data.url;

            // 2. Kirim ke Google Apps Script Bapak
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyYvP832S_mU01PY7klohIuCGEXhMl8Ej_LWDcrVSilVAyM5-_Y-2PQeA9vSkjOISgE/exec'; 

            await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data: [{
                        'waktu': new Date().toLocaleString('id-ID'),
                        'nama': document.getElementById('nama').value,
                        'kegiatan': document.getElementById('kegiatan').value,
                        'komoditas': komoditasFinal,
                        'responden': document.getElementById('responden').value,
                        'kualitas': document.getElementById('kualitas').value,
                        'perkembangan': perkembanganFinal,
                        'harga': document.getElementById('harga').value,
                        'pasokan': document.getElementById('pasokan').value,
                        'wilayah': document.getElementById('wilayah').value,
                        'fenomena': "Ket: " + document.getElementById('penjelasan').value,
                        'foto': photoUrl,
                        'lokasi': userCoords
                    }]
                })
            });

            alert("‚úÖ DATA BERHASIL DIKIRIM KE GOOGLE SHEETS!");
            location.reload(); 

        } catch (e) {
            alert("Gagal: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = "üöÄ Kirim ke Database";
        }
    }
    </script>
</body>
</html>

